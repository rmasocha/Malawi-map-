<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <!-- The title of the web page -->
  <title>Type your page title here</title>

  <!-- Link to Montserrat font -->
  <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">
  <!-- Link the css files -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.3/leaflet.css">

  <!-- The rest of the css -->
  <style>
    /* This declares the following code to be css */

    body {
      margin: 0px;
      height: 100%;
      width: 100%;
    }

    /* Add banner to header background */
    header {
      position: fixed;
      top: 0px;
      width: 100%;
      height: 52px;
      background-color: #000000;
      box-shadow: 0px 0px 5px black;
      z-index: 800;
    }

    /* Set font styles */
    h1 {
      font-family: 'Montserrat', sans-serif;
      color: white;
      font-size: 16px;
      display: inline-block;
      margin-top: 0.5em;
      margin-bottom: 0.0em;
      margin-left: 0.5em;
      margin-right: 0;
      font-weight: normal;
    }

    h2 {
      font-family: 'Montserrat', sans-serif;
      font-size: 12px;
      color: white;
      display: inline-block;
      margin-top: 0.25em;
      margin-bottom: 0.0em;
      margin-left: 0.75em;
      margin-right: 0;
      font-weight: normal;
    }

    h3 {
      font-family: 'Montserrat', sans-serif;
      padding: 0px;
      font-size: 16px;
      font-weight: bold;
    }

    h4 {
      font-family: 'Montserrat', sans-serif;
      padding: 0px;
      font-size: 13px;
      line-height: 14px;
    }

    h5 {
      font-family: 'Montserrat', sans-serif;
      padding: 0px;
      font-size: 12px;
      line-height: 13px;
      font-weight: normal;
    }

    h6 {
      padding: 0px;
      font-size: 12px;
      font-family: "Montserrat";
    }

    /* Set map parameters */
    #map {
      position: fixed;
      bottom: 0px;
      width: 100%;
      top: 52px;
    }

    /* Set time slider styles */
    #slider {
      position: absolute;
      height: 25px;
      bottom: 20px;
      left: 125px;
      z-index: 1000;
      background-color: #FFFFFF;
      border-radius: 3px;
      box-shadow: 0px 0px 0px 2px rgba(0, 0, 0, 0.3);
    }

    /* Set temporal legend styles */
    #temporal {
      position: absolute;
      width: 100px;
      height: 25px;
      bottom: 20px;
      background-color: #FFFFFF;
      border-radius: 3px;
      box-shadow: 0px 0px 0px 2px rgba(0, 0, 0, 0.3);
    }

    /* Set the styles for the text span in the temporal legend */
    #temporal span {
      font-family: 'Montserrat', sans-serif;
      font-size: 12px;
      position: absolute;
      bottom: 3px;
      left: 15px;
    }
  </style> <!-- Escape the css code -->

</head>

<body>
  <header>
    <h1>Type your map title here</h1><br>
    <h2>Ruvarashe Masocha, University of Iowa</h2>
  </header>

  <!-- The map will go inside this div below -->
  <div id="map"></div>

  <!-- ui slider -->
  <div id='slider' class='leaflet-control'>
    <!-- Use the first and last year of the time data as the min and max. Set the initial value as the first year. Set the steps at one year. -->
    <input type='range' min="1920" max="1938" value="1920" step="1" class="slider" />
  </div>

  <!-- temporal legend -->
  <div id='temporal' class='leaflet-control'>
    <h6 class='txt-bold'><span></span></h6>
  </div>

  <!-- Link to the js files -->
  <script src="https://code.jquery.com/jquery-3.2.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.3/leaflet.js"></script>
  <script src="https://d3js.org/d3.v4.min.js"></script>

  <!-- The rest of the JavaScript -->
  <script>
    // Initialize the map
    var map = L.map('map', {
      center:[-20.00, 30.00], // You can hardcode the center of the map on specific coordinates
      zoom: 6 // You can hardcode the initial zoom level
    });

    // Add openstreet baselayer to the map (other options can be found here: https://leaflet-extras.github.io/leaflet-providers/preview/)
    var baseContemporary = L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18, // Set the maximum zoom level
      minZoom: 2, // Set the minimum zoom level
      attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    var base1922 = L.tileLayer('maptiles/political/{z}/{x}/{y}.png', {
      minZoom: 2,
      maxZoom: 7,
      tms: false,
      attribution: 'Generated by TilesXYZ'
    }).addTo(map); // Add the baselayer to the map

    // Add a scale bar
    L.control.scale({
      position: 'bottomright' // Position the scale bar at the bottom-right corner
    }).addTo(map);


    // Add functions to style the polygons by values
    function getColorGroup(d) {
      return d === "Barotseland" ? '#8ad77e' :
      d === "Bemba-Lamba" ? '#eb8a14' :
      d === "San" ? '#ef7890' :
      d === "Cushites, Southern" ? '#de350f' :
      d === "Fang-Dzem" ? '#e3ee8c' :
      d === "Khoekhoen" ? '#cb2a2d' :
      d === "Ila-Tonga" ? '#5fc0d3' :
      d === "Kasai" ? '#2f95cb' :
      d === "Kenya Highlands" ? '#5662df' :
      d === "Lower Congo" ? '#7cca55' :
      d === "Luba" ? '#4be3c5' :
      d === "Luguru-Zigula" ? '#8a44d5' :
      d === "Lunda" ? '#ebe280' :
      d === "Maravi" ? '#0e6ad9' :
      d === "Masai" ? '#b33dee' :
      d === "Mongo" ? '#c24cd7' :
      d === "Ngonde" ? '#eb558e' :
      d === "Nguni" ? '#cba02b' :
      d === "Nyamwezi" ? '#32d4d2' :
      d === "Nyika" ? '#70ca85' :
      d === "Rift" ? '#df6bdb' :
      d === "Riverain Congo" ? '#df5cc1' :
      d === "Rufiji" ? '#81e4aa' :
      d === "Rukwa" ? '#4d0ded' :
      d === "Shona-Thonga" ? '#89e88e' :
      d === "Sotho" ? '#53e4aa' :
      d === "Southwestern Bantu" ? '#98c864' :
      d === "Swahili" ? '#cc845a' :
      d === "West Lacustrine Bantu" ? '#9188eb' :
      d === "Western Angola" ? '#bae457' :
      d === "Yao-Makonde" ? '#5b81e8' :
            'rgba(0,0,0,0.0)';
    };

    // Load your data asynchronously
    d3.queue()
      .defer(d3.json, 'data/southern_africa_ethnicity_murdock_1959.geojson') // Provide the path to your data file
      .defer(d3.json, 'data/Malawi_immigration_test.geojson') // Add more files if needed
      .await(drawMap); // Load the layers after the map loads

    // Provide instructions for drawing the map
    function drawMap(err, data1, data2) {

      var dataOne = L.geoJson(data1, { // Define the first data layer with a variable

        // Style the layer
        style: function(feature) {
          return {
            color: "grey",
            weight: 1,
            opacity: 0.75,
            fillColor: getColorGroup(feature.properties.CultureGrp), // This returns the color assignments from the getColorGroup function above
            fillOpacity: 0.5
          };
        },

        // Restyle on mouseover, reset style on mouseout
        onEachFeature: function(feature, layer) {

          var props = layer.feature.properties; // Get the properties of the layer features
          console.log(props); // Check these properties in the developer web console

          // Bind a popup window to the layer
          layer.bindPopup("<h3>" + props['NAME'] + "</h3>" +
            "<h4>Cultural Group:" +
            "</h4><h5>" + props['CultureGrp'] +
            //"<br>Domestic Organization: " + "<br>" + props['v8tr'] +
            //"<br>Residence After Marriage: " + "<br>" + props['v10tr'] +
            //"<br>Community Marriage Organization: " + "<br>" + props['v15tr'] +
            "</h5><h4>Settlement Patterns: " + "</h4><h5>" + props['v30tr'] +
            "</h5><h4>Community Size: " + "</h4><h5>" + props['v31tr'] +
            //"<br>Local Jurisdictional Hierarchy: " + "<br>" + props['v32r'] +
            //"<br>Deities: " + "<br>" + props['v34tr'] +
            //"<br>Post-Partem Sex Taboo: " + "<br>" + props['v36tr'] +
            //"<br>Male Genital Mutilation: " + "<br>" + props['v37tr'] +
            "</h5><h4>Subsistence Economy: " + "</h4><h5>" + props['v42tr'] +
            "</h5><h4>Class Stratification: " + "</h4><h5>" + props['v66tr'] +
            //"<br>Type of Slavery: " + "<br>" + props['v70tr'] +
            "</h5><h4>Property Inheritance: " + "</h4><h5>" + props['v74tr'] +
            /*"<br>Dwelling Roof: " + "<br>" + props['v82tr'] + */"</h5>"
          );

          layer.on({

            // Define what happens on mouseover
            mouseover: function(e) {
              var layer = e.target;
              layer.setStyle({
                color: '#3232FF',
                weight: 3,
                opacity: 0.75
              });
            },

            // Define what happens on mouseout
            mouseout: function(e) {

              // Reset the layer styles
              dataOne.resetStyle(e.target);

            },

          });
        }

      }).addTo(map); // Add the first data layer to the map

      var propEmigration = L.geoJson(data2, { // Define the first data layer with a variable

        pointToLayer: function(feature, ll) {

          //style the points as circle markers
          return L.circleMarker(ll, {
            weight: 1, // set the weight of the border
            opacity: 1, // set the opacity of the border
            fillOpacity: 0.5, // set the opacity of the fill color
          })
        }, //end pointToLayer

        //restyle on mouseover, reset style on mouseout
        onEachFeature: function(feature, layer) {

          //define what happens on mouseover
          layer.on("mouseover", function(e) {
            layer.setStyle({
              fillColor: '#e59866',
            });
          });

          //define what happens on mouseout
          layer.on("mouseout", function(e) {
            layer.setStyle({
              opacity: 1,
              color: '#ba4a00',
              fillColor: '#dc7633',
            });
          });

        } //end onEachFeature

      }); // End propEmmigration

      var propImmigration = L.geoJson(data2, { // Define the first data layer with a variable

        pointToLayer: function(feature, ll) {

          //style the points as circle markers
          return L.circleMarker(ll, {
            weight: 1, // set the weight of the border
            opacity: 1, // set the opacity of the border
            fillOpacity: 0.5, // set the opacity of the fill color
          })
        }, //end pointToLayer

        //restyle on mouseover, reset style on mouseout
        onEachFeature: function(feature, layer) {

          var props = layer.feature.properties;
          console.log(props);

          //define what happens on mouseover
          layer.on("mouseover", function(e) {
            layer.setStyle({
              fillColor: '#aed6f1',
            });
          });

          //define what happens on mouseout
          layer.on("mouseout", function(e) {
            layer.setStyle({
              opacity: 1,
              color: '#2e86c1',
              fillColor: '#5dade2',
            });
          });

        } //end onEachFeature

      }); // End propImmigration

      // Fit the map to the extent of the first data layer upon drawing
      //map.fitBounds(dataOne.getBounds());

      // Define the overlay layers for the layer control
      var overlays = {
        "Political Map, 1922": base1922,
        "Ethnic Groups, 1959": dataOne,
        "Proportional Emigration": propEmigration,
        "Proportional Immigration": propImmigration
      };

      // Send the layers to the layer control
      L.control.layers(null, overlays, {
        collapsed: false,
      }).addTo(map);

      // Define the current year selected by the slider
      var currentYear = $('.slider').val();

      createTemporalLegend(currentYear); // Produces temporal legend upon map loading
      sequenceUI(propEmigration, propImmigration); // Produces the time slider and sends the layers to it
      updateCircles(propEmigration, propImmigration, currentYear); // Updates the layers according to the year selected by the slider

    }; //end drawMap function

    // Add a temporal legend in sync with the UI slider
    function createTemporalLegend(currentYear) { // THE FIRST TEMPORAL LEGEND

      var temporalLegend = L.control({
        position: 'bottomleft' // place the temporal legend at bottom left corner
      });

      // when added to the map
      temporalLegend.onAdd = function(map) {

        var div = L.DomUtil.get("temporal"); // get the style settings

        // disable the mouse events
        L.DomEvent.addListener(div, 'mousedown', function(e) {
          L.DomEvent.stopPropagation(e);
        });

        return div; // return the style settings

      }

      $('#temporal span').html("Year: " + currentYear); // change grade value to that currently selected by UI slider

      temporalLegend.addTo(map); // add the temporal legend to the map

    }; // End createTemporalLegend function

    // add a UI slider
    function sequenceUI(propEmigration, propImmigration) { // THE FIRST UI SLIDER

      // create Leaflet control for the slider
      var sliderControl = L.control({
        position: 'bottomleft',
        follow: true
      });

      // add controls to the slider
      sliderControl.onAdd = function(map) {

        var controls = L.DomUtil.get("slider"); // get the style settings

        // disable the mouse events and map dragging on mousedown
        L.DomEvent.addListener(controls, 'mousedown', function(e) {
          L.DomEvent.stopPropagation(e);
          map.dragging.disable();
        });

        // re-enable map dragging on mouseout
        L.DomEvent.addListener(slider, "mouseout", function(e) {
          map.dragging.enable();
        });

        return controls; // return the style settings

      }

      // add the control to the map
      sliderControl.addTo(map);

      $('.slider')
        .on('input change', function() {
          var currentYear = $(this).val(); // identifies the year selected
          createTemporalLegend(currentYear);
          updateCircles(propEmigration, propImmigration, currentYear);
        });

    }; // End sequenceUI function

    // calculate circle radii
    function calcRadius(val) {
      var radius = Math.sqrt(val / Math.PI);
      return radius * 1.25; // adjust 16 as a scale factor
    }; // end calcRadius() function

    // Define updateCircles function
    function updateCircles(propEmigration, propImmigration, currentYear) {

      // change the layer based on the year-dependent data
      propEmigration.eachLayer(function(layer) {

        var props = layer.feature.properties; // Define a properties variable called props

        var radius = calcRadius(Number(props['emigrants_' + currentYear]));
        layer.setRadius(radius);
        if (radius > 0) {
          layer.setStyle({
            opacity: 1,
            color: '#ba4a00',
            fillColor: '#dc7633',
          })
        };

        //bind a popup window to each circle marker
        layer.bindPopup("<h3>" + props.country + "</h3>" +
          "<h4>Number of Emigrants: " + props['emigrants_' + currentYear] + "</h4>"
        );

      });

      propEmigration.addTo(map);

      // change the layer based on the year-dependent data
      propImmigration.eachLayer(function(layer) {

        var props = layer.feature.properties; // Define a properties variable called props

        var radius = calcRadius(Number(props['immigrants_' + currentYear]));
        layer.setRadius(radius);
        if (radius > 0) {
          layer.setStyle({
            opacity: 1,
            color: '#2e86c1',
            fillColor: '#5dade2',
          })
        };

        //bind a popup window to each circle marker
        layer.bindPopup("<h3>" + props.country + "</h3>" +
          "<h4>Number of Immigrants: " + props['immigrants_' + currentYear] + "</h4>"
        );

      });

      propImmigration.addTo(map);

    }; // End updateCircles function
  </script>
</body>

</html>
